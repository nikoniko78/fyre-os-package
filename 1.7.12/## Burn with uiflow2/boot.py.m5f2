{"version":"V2.0","versionNumber":"V2.3.9","type":"cardputer-adv","components":[{"name":"screen","type":"screen","layer":0,"screenId":"builtin","screenName":"","id":"__cardputer-adv_screen","createTime":1765257401827,"x":0,"y":0,"width":240,"height":135,"backgroundColor":"#000000","size":0,"isSelected":true}],"resources":[{"hardware":["hardware_button","hardware_pin_button","imu","speaker","ir","matrixkeyboard","mic","sdcard"]}],"units":[],"hats":[],"caps":[],"chains":[],"bases":[],"plcmodules":[],"i2cs":[],"chainBus":[],"blockly":"<block type=\"basic_on_setup\" id=\"setup_block\" deletable=\"false\" x=\"50\" y=\"50\"><mutation isBegin=\"true\"></mutation><field name=\"UPDATEOP\">true</field><statement name=\"FUNC\"><block type=\"system_m5_begin\" id=\"vXTI/:T(zzXQ5EE2@XZX\"></block></statement></block><block type=\"basic_on_loop\" id=\"loop_block\" deletable=\"false\" x=\"450\" y=\"50\"><mutation isUpdate=\"true\"></mutation><field name=\"UPDATEOP\">true</field><statement name=\"FUNC\"><block type=\"system_m5_update\" id=\":)*}{P$Nck8b8B-Tj1X;\"></block></statement></block>","screen":[{"simulationName":"Built-in","type":"builtin","width":240,"height":135,"scale":0.43,"screenName":"","blockId":"","screenColorType":0,"id":"builtin","createTime":1765257401821}],"logicWhenNum":0,"pythonCode":"import os\nimport time\nimport json\nimport random\nimport importlib.util\nfrom m5stack_ui import M5Screen, M5Image\nfrom machine import Pin\nfrom m5stack import btnA, btnB, btnC\n\nscreen = M5Screen()\nscreen.clean_screen()\n\n# ------------------------- IMAGES -------------------------\nIMG_NO_SD = \"sderror.png\"           # no SD inserted\nIMG_READ_ERR = \"sdreaderror.png\"    # SD inserted but unreadable\nIMG_WRITE_ERR = \"sdwriteerror.png\"  # SD write-protected\nIMG_MISSING = \"missingfiles.png\"    # missing main.py or hmenu.py\nIMG_KEY_ERR = \"safetykeyerr.png\"    # safety key mismatch or missing\nIMG_BYPASS_CONFIRM = \"confirmkeybypass.png\"  # confirm bypass\n\n# ------------------------- PATHS --------------------------\nINTERNAL_KEY_FILE = \"/flash/ossafetykey.json\"\nSD_KEY_FILE = \"/sd/ossafetykey.json\"\n\n# ------------------------- BUTTON -------------------------\nBTN0 = Pin(0, Pin.IN, Pin.PULL_UP)   # Stamp S3A boot button\nBYPASS_MODE = False                  # set True for bypass at boot\n\n# ------------------------- SD HELPERS -------------------------\ndef sd_present():\n    try:\n        return \"sd\" in os.listdir(\"/\")\n    except:\n        return False\n\ndef sd_is_readable():\n    try:\n        os.listdir(\"/sd\")\n        return True\n    except:\n        return False\n\ndef sd_is_writable():\n    test_path = \"/sd/.writetest.tmp\"\n    try:\n        with open(test_path, \"w\") as f:\n            f.write(\"test\")\n        os.remove(test_path)\n        return True\n    except:\n        return False\n\ndef show_error(img):\n    screen.clean_screen()\n    M5Image(img, x=0, y=0)\n    while True:\n        time.sleep(1)  # Keep image displayed indefinitely\n\n# ------------------------- SAFETY KEY -------------------------\ndef generate_random_key():\n    return str(random.randint(10_000_000_000, 99_999_999_999))\n\ndef load_key(path):\n    try:\n        with open(path, \"r\") as f:\n            return json.load(f).get(\"safety_key\", None)\n    except:\n        return None\n\ndef write_key(path, key):\n    try:\n        with open(path, \"w\") as f:\n            json.dump({\"safety_key\": key}, f)\n        return True\n    except:\n        return False\n\ndef make_read_only(path):\n    \"\"\"Attempt to make key file read-only.\"\"\"\n    try:\n        os.chmod(path, 0o444)\n    except:\n        pass  # Some filesystems ignore chmod\n\ndef verify_not_modified(path, original_key):\n    \"\"\"Stop boot if key was tampered with.\"\"\"\n    current = load_key(path)\n    if current != original_key:\n        show_error(IMG_KEY_ERR)\n        raise SystemExit(\"Safety key tampering detected\")\n\ndef ensure_safety_key():\n    \"\"\"Check safety key; stop boot if SD key missing or mismatch.\"\"\"\n    internal_key = load_key(INTERNAL_KEY_FILE)\n    if internal_key is None:\n        internal_key = generate_random_key()\n        write_key(INTERNAL_KEY_FILE, internal_key)\n    make_read_only(INTERNAL_KEY_FILE)\n\n    sd_key = load_key(SD_KEY_FILE)\n\n    # Treat missing SD key as mismatch\n    if sd_key is None or sd_key != internal_key:\n        show_error(IMG_KEY_ERR)\n        raise SystemExit(\"Safety key missing or mismatch\")\n    make_read_only(SD_KEY_FILE)\n\n# ------------------------- BYPASS BUTTON -------------------------\ndef check_bypass_request():\n    \"\"\"Check if user is holding BTN0 at power-on to bypass SD key.\"\"\"\n    global BYPASS_MODE\n    if BTN0.value() == 0:  # pressed\n        screen.clean_screen()\n        M5Image(IMG_BYPASS_CONFIRM, x=0, y=0)\n        timeout = time.ticks_ms() + 30000  # 4 seconds to press Enter\n        while time.ticks_diff(timeout, time.ticks_ms()) > 0:\n            if btnA.isPressed():  # confirm bypass\n                BYPASS_MODE = True\n                return\n            if btnB.isPressed() or btnC.isPressed():  # cancel bypass\n                return\n\n# ------------------------- STEP 1: WAIT FOR SD -------------------------\ntime.sleep(1)\nwhile True:\n    if not sd_present():\n        show_error(IMG_NO_SD)\n    elif not sd_is_readable():\n        show_error(IMG_READ_ERR)\n    elif not sd_is_writable():\n        show_error(IMG_WRITE_ERR)\n    else:\n        break\n    time.sleep(3)\n\nscreen.clean_screen()\n\n# ------------------------- STEP 2: CHECK BYPASS -------------------------\ncheck_bypass_request()\nif not BYPASS_MODE:\n    ensure_safety_key()\nelse:\n    print(\">>> SAFETY KEY BYPASS ACTIVE FOR THIS BOOT <<<\")\n\n# ------------------------- STEP 3: OPTIONAL MODULES -------------------------\nBASE_PATH = \"/sd/Apps\"\nCONFIG_FILE = \"/sd/auto_run_config.txt\"\nCLEANER_FILE = os.path.join(BASE_PATH, \"SD Cleaner.py\")\nWIFI_MANAGER_FILE = os.path.join(BASE_PATH, \"Wifi Manager.py\")\n\n# SD Cleaner\ntry:\n    if os.path.exists(CONFIG_FILE):\n        with open(CONFIG_FILE, \"r\") as f:\n            if f.read().strip() == \"ON\" and os.path.exists(CLEANER_FILE):\n                spec = importlib.util.spec_from_file_location(\"cleaner\", CLEANER_FILE)\n                cleaner = importlib.util.module_from_spec(spec)\n                spec.loader.exec_module(cleaner)\nexcept:\n    pass\n\n# Wifi Manager\ntry:\n    if os.path.exists(WIFI_MANAGER_FILE):\n        spec = importlib.util.spec_from_file_location(\"wifi_manager\", WIFI_MANAGER_FILE)\n        wifi_manager = importlib.util.module_from_spec(spec)\n        spec.loader.exec_module(wifi_manager)\n        if hasattr(wifi_manager, \"connect\"):\n            try:\n                wifi_manager.connect()\n            except:\n                pass\nexcept:\n    pass\n\n# ------------------------- STEP 4: CHECK REQUIRED FILES -------------------------\nMAIN_FILE = \"/sd/main.py\"\nHMENU_FILE = \"/sd/hmenu.py\"\n\ndef check_required_files():\n    missing = []\n    if not os.path.exists(MAIN_FILE):\n        missing.append(\"main.py\")\n    if not os.path.exists(HMENU_FILE):\n        missing.append(\"hmenu.py\")\n    return missing\n\nmissing = check_required_files()\nif missing:\n    show_error(IMG_MISSING)\n    raise SystemExit(\"Missing required files: \" + \", \".join(missing))\n\n# ------------------------- STEP 5: BOOT MAIN -------------------------\ntry:\n    spec = importlib.util.spec_from_file_location(\"sd_main\", MAIN_FILE)\n    sd_main = importlib.util.module_from_spec(spec)\n    spec.loader.exec_module(sd_main)\nexcept:\n    show_error(IMG_READ_ERR)\n","customList":[]}